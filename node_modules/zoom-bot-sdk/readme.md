# Zoom-bot-sdk


This library provide interfaces to quickly build bots and applications for Zoom Messaging framework. All the complexities of oAuth2, sending messages and receiving notifications to and from Zoom client are hidden within the library so that you can focus on building the business logic of your application.

## Requirements

This package supports Node v8 and higher.

## Installation

npm install zoom-bot-sdk

## Features

Zoom connector offers Resource Owner && Authorization Server for you to integrate with zoom client . Each app can connect different user to trigger different actions.

## Preparatory work

in our [marketplace](https://marketplace.zoom.us/) you can config a new app

## Example one 

write message in im,and get info from bot app



```js
//when write mesage in zoom client group just like 
/zoom create foxjiang 2019-08-08
```

```js
var express = require('express');
let app = express();
const { oauth2, client, setting } = require('zoom-bot-sdk');
setting.setUrl('https://dev.zoom.us'); // careful,if you are in projection,not use this.

let oauth2Client = oauth2(clientId,clientSecret,redirectUri);

//create zoomBot
let zoomBot = client(clientId,verifyCode,botJid,botName)
.commands([{ command: 'create', description: 'create a new meeting', hint:' <userName> <date>'}])
.defaultAuth(oauth2Client.connect());

zoomBot.on('commands',function(e){
    let {payload,data,type,command,message}=e;//origin message from IM is message
    let { toJid: to_jid, accountId: account_id, name } = payload;
    if(command==='create'){
      /* 
       we format your command string /zoom create foxjiang 2019-08-08 in group chat
       and command==='create' data=['foxjiang','2019-08-08'] 
      */
      //group explain message from channelList，type==='one' explain message from 1:1 chat
      let text = type === 'group' ? `message user ${data[1]}` : `message user ${data[1]}`;
      //create a new userApp and run,you can store your userApp in your code
      let foxApp = zoomBot.create({auth: oauth2Client.connect()});
      //replay a message to zoom clinet
      foxApp.sendMessage({
        to_jid, 
        account_id, 
        body: {type:'message',text}, header: { text: `reply from ${name}`}
      });
    }
    // else if(command==='delete'){//other command logic}
});

//message route
app.all('/api/message', function (req, res) {//get message api
  let { body, headers } = req;
  //i will add help,
  zoomBot.handle({ body, headers }, function (err) {
    if (err) { console.log(err); }
    res.send('ok');
  });
});
//other,your port listen code 
```

## Example two

oauth2 auth && listen message && send message to special account

```js

var express = require('express');
let app = express();

const { oauth2, client, setting } = require('zoom-bot-sdk');
setting.setUrl('https://dev.zoom.us'); // if you are in projection,not use this.

let oauth2Client = oauth2(clientId,clientSecret,redirectUri);
oauth2Client.on('tokens', function (tokens){});

let zoomBot = client(clientId,verifyCode,botJid,botName)
.command([{ command: 'create', description: 'create a new meeting', hint: ' <userName> <date>' }])
.defaultAuth(oauth2Client.connect());

let foxApp=null;//oauth app
zoomBot.on('commands', async function (event) {
    let {command} = event;
    if(foxApp===null){return;}
        try {
            let userInfo = await foxApp.getUser();
            let channelList = await foxApp.channelList(userInfo.id);
            if(channelList.length>0){
                let obj = channelList[1];
                let { group_jid } = obj;
                await foxApp.sendMessage({
                    to_jid: group_jid, account_id: userInfo.account_id,
                    body: { "type": "message", "text": `message from command ${command}` },
                    header: { text: 'fox reply' }
                });
            } 
        }
        catch (e) {
            console.log(e);
        }
});

//message route
app.all('/api/message', function (req, res) {//get message api
    let { body, headers } = req;
    zoomBot.handle({ body, headers }, function (err) {
        if (err) { console.log(err); }
        res.send('ok');
    });
});

// oauth2 route
app.get('/api/oauth', async function (req, res) {
    try {
        let connection = await oauth2Client.connectByCode(req.query.code);
        //change foxApp to current oauth2 user
        foxApp = zoomBot.create({ auth: connection });
        res.send('ok');
    } catch (e) {
        res.send(e);
    }
});
//other,your port listen code 

```


## Usage

## global

```js
const { oauth2, client, setting } = require('zoom-bot-sdk');
// setting.setUrl('https://dev.zoom.us'); default is https://api.zoom.us . dev.zoom.us if for test
```

## oauth2 with zoom

#### init oauth instance

```js

// const {oauth2} =require('zoom-bot-sdk');
const oauth2Client=oauth2(Your Client Id,Your Client Secret,Your redirect url);

/*
interface ClientTokens{
access_token:string;
token_type:string;
refresh_token:string;
expire_in:number;
scope:string
}
*/
//trigger when get new tokens
oauth2Client.on("tokens",(tokens)=>{
//store tokens to db,or other handles
});

/*
interface ClientTokens{
access_token:string;
token_type:string;
refresh_token:string;
expire_in:number;
}
*/
//trigger when get new clientTokens
oauth2Client.on("clientTokens",(tokens)=>{

});

/*
interface Err{
    type:string;//temporary support value:(token|clientToken)
    message:any;
}
*/
oauth2Client.on("error",(err)=>{

});

```

#### create auth connection

```js
//If you just have a sendmessage action requirement ， no need for get access_token,you can just use let connection= oauth2Client.connect();
//getUser and channelList need accessToken.
let connection = await oauth2Client.connectByCode(code);
let connection = await oauth2Client.connectByRefresh(refresh_token);
let connection = oauth2Client.connectByTokens(tokens);
// if you just need to trigger sendMessage action,and you already have account_id and group_jid from your db,you can just to use oauth2Client.connect(),and then you can use sendMessage action only
let connection = oauth2Client.connect(); //not auto request tokens
```

#### connection api

```js
let tokens = await connection.requestTokensByRefresh(refresh_token);
let tokens = await connection.requestTokens(code);
let clientTokens = await connection.requestClientTokens();
let ifExpired = connection.expired(); //check access_token whether expired or not
let ifClientExpired = connection.expiredClient(); //check client access_token whether expired or not
let tokens = connection.getTokens();
let clientTokens = connection.getClientTokens();
connection.setTokens(tokens); //if you want to update tokens temporary
```

## zoom client action && message

#### create zoombot instance and config command&&version for help command

```js
// const {client}=require('zoom-bot-sdk');
//you can get verification token and robot_jid in zoom marketplace features.
/* 
   Interface CommandObj{
      command:string;//your command name
      description:string;//your description of command
      hint?:string;//your command arguments
   }

   opts:CommandObj|Array<CommandObj>
*/
let zoomBot=client(your clientid,your Verification Token,your robot_jid)
.command(opts).defaultAuth(oauth2Client.connect());//you must to config a default auth for default help command,just use oauth2Client.connect()
```

#### create one business instance with oauth2 connection in zoombot

```js
//if use auth argument no need to import tokens argument
//access_token will auto be requested when judge expired
const userApp = zoomBot.create({
  auth: connection
});
```

#### use business instance to handle action(for now,only support getUser,channelList,sendMessage three action)

get user

```js
//if email is empty ,will return userId corresponds to the current access_token ,if send specific email，will return the corresponding sub-account under account 。
/* 
   interface UserInfo{
       id:string;//user id
       account_id:string;
       email:string;
       [propName: string]: any;
   }
   email?:string
*/

let userInfo = await userApp.getUser(email);
```

get channelList

```js

// the userId which you can get from getUser method or callback from on event message
/*
    interface ChannelItem{
       group_jid:string;
       name:string;
       type:number;
       created_time:number;
       modified_time:number;
    }

    channelInfo:Array<ChannelItem>
*/

let channelInfo=await userApp.channelList(userId);

```

sendMessage

```js
/* 
    body example:
    {
      "type": "message",
      "text": "this is sendmessage info",
      "style": { "color": "#000000", "bold": true, "itatic": false }
    }

    header example:
    { "text": "kogss" }

    Body:Array<Msg>|Msg;

    Interface Header{
        text:String;
        style:Style;
    }
    Interface Option{
        account_id:String;//account_id from getUser action userInfo
        to_jid:String;//to_jid from channelList group_jid
        body:Body;// send one or multiple message
        header:Header;
    }
*/

let backInfo = await userApp.sendMessage(option);
```

#### message event

handle request

```js
expressApp.get('/someapi', function(req, res, next) {
  let { body, headers } = req;
  zoomBot.handle({ body, headers }, function(err) {
    if (err) {
      console.log(err);
    }
  });
  res.send('some res');
});
```

listen message


now we only support notification message from im,We will support more message callbacks after the zoom client release, which won't be long


```js
/* 
     interface Payload{
            robotJid:String;
            userJid:String;
            toJid:String,
            accountId:String,
            userId:String,
            name:String,
            timestamp:Number,
            cmd:String
        }
*/

//support multiple async function
//when have command : /zoom create foxjiang 2019-08-08
/* 
   Interface Event{
      type:string;//one or group which come from im user type
      payload:Payload;
      message:string;//origin content from im ,just like 'create foxjiang 2019-08-08'
      data:Array<string>;//just like ['foxjiang','2019-08-08']
      command:string;//notification,just like create
   }
*/

zoomBot.on('commands',function(event){
// handle your logic
});

```

#### body type


We will support more message body after the new zoom client release, which won't be long

```js
//notification message
  {
            "type":"message",
            "text":"this is first message.",
            "style":{
               "color":"#FFFFFF",
               "bold":true,
               "itatic":false
            }
         }
//link message
 {
            "type":"message",
            "text":"zoom.us",
            "link":"https://zoom.us"
 }


```

#### header type

```js

{"text":"your header text"}
or
{"text":"your header text",
        "style":{
        "color":"#000000",
        "bold":true,
        "itatic":false
        }
}
```


## notice 

old event app.command app.on('command',function(){}) was abandoned,but it still exists and is no longer maintained