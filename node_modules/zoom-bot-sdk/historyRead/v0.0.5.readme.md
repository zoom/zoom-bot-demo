# Zoom-bot-sdk

This library provide interfaces to quickly build  bots and applications for Zoom Messaging framework. All the complexities of oAuth2, sending messages and receiving notifications to and from Zoom client are hidden within the library so that you can focus on building the business logic of your application.

## Requirements

This package supports Node v8 and higher.

## Installation

npm install zoom-bot-sdk

## Features

Zoom connector offers Resource Owner && Authorization Server for you to integrate with zoom client . Each app can connect different user to trigger different actions.


## Example

A simple example in express with mock data

```js
var express = require('express');
let http = require('http');
var bodyParser = require("body-parser");
let app = express();
app.use(express.static('./static'));
app.use(bodyParser.json());
const { oauth2, client, setting } = require('zoom-bot-sdk');
setting.setUrl('https://dev.zoom.us'); // if you are in production,not use this.
let oauth2Client = oauth2(
  '6gU6hZk1qaCYmDw',//client id
  '784qQEnt7EIWx9ArBdocIBRV9C',//client secret
  'http://localhost:3003/api/oauth'//redirect uri
);
oauth2Client.on('tokens', function (tokens) { console.log(tokens);});
let jiraBot = client(
  '6gU6hZk1qaCYmDw',//client id
  'pTzcaP9ISlCDXmRDGQ',//verify code
  'v1yj6l-rusq4mgyl0kzq@xmppdev.zoom.us'//jid
);
jiraBot.on('notification', function ({ data }) {console.log(data); });
app.post('/api/message',function(req,res){//get message api
    let { body, headers } = req;
    jiraBot.handle({ body, headers},function(err){
        if(err){console.log(err);}
    });
    res.send('ok');
});
app.get('/api/oauth', async function(req, res) {
  try {
    let connection = await oauth2Client.connectByCode(req.query.code);
    let userApp = jiraBot.create({ auth: connection });
    let userInfo = await userApp.getUser();
    let channelList = await userApp.channelList(userInfo.id);
    let obj = channelList[1];
    let { group_jid } = obj;
    let msg = await userApp.sendMessage({
      to_jid: group_jid,
      account_id: userInfo.account_id,
        body: {
            "type": "actions",
            "limit": 3,
            "items": [ { "text": "button1", "value": "name1" }, { "text": "button2", "value": "name2" } ]
        },
      header: { text: 'kogss' }
    });
  } catch (e) {
    // console.log(e);
  }
  res.send('ok');
});
var server = http.createServer(app);
server.listen('3003', function () { console.log(`3003 is opened`); });

//if you need html page to trigger oauth,add html as follows 
 <a href='https://dev.zoom.us/oauth/authorize?client_id=6gU6hqaCYmDw&response_type=code&redirect_uri=your redirect uri'>oauth</a>
```

## Usage 

## global

```js
const { oauth2, client, setting } = require('zoom-bot-sdk');
// setting.setUrl('https://dev.zoom.us'); default is https://api.zoom.us . dev.zoom.us if for test
```

## oauth2 with zoom

#### init oauth instance

```js

// const {oauth2} =require('zoom-bot-sdk');
const oauth2Client=oauth2(Your Client Id,Your Client Secret,Your redirect url);

/*
interface ClientTokens{
access_token:string;
token_type:string;
refresh_token:string;
expire_in:number;
scope:string
}
*/
//trigger when get new tokens
oauth2Client.on("tokens",(tokens)=>{
//store tokens to db,or other handles
});

/*
interface ClientTokens{
access_token:string;
token_type:string;
refresh_token:string;
expire_in:number;
}
*/
//trigger when get new clientTokens
oauth2Client.on("clientTokens",(tokens)=>{

});

/*
interface Err{
    type:string;//temporary support value:(token|clientToken)
    message:any;
}
*/
oauth2Client.on("error",(err)=>{

});

```

#### create auth connection

```js
//If you just have a sendmessage action requirement ， no need for get access_token,you can just use let connection= oauth2Client.connect();
//getUser and channelList need accessToken.
let connection = await oauth2Client.connectByCode(code);
let connection = await oauth2Client.connectByRefresh(refresh_token);
let connection = oauth2Client.connectByTokens(tokens);
// if you just need to trigger sendMessage action,and you already have account_id and group_jid from your db,you can just to use oauth2Client.connect(),and then you can use sendMessage action only
let connection = oauth2Client.connect(); //not auto request tokens
```


#### connection api

```js
let tokens = await connection.requestTokensByRefresh(refresh_token);
let tokens = await connection.requestTokens(code);
let clientTokens = await connection.requestClientTokens();
let ifExpired = connection.expired(); //check access_token whether expired or not
let ifClientExpired = connection.expiredClient(); //check client access_token whether expired or not
let tokens = connection.getTokens();
let clientTokens = connection.getClientTokens();
connection.setTokens(tokens); //if you want to update tokens temporary
```

## zoom client action && message

#### create zoombot instance

```js
// const {client}=require('zoom-bot-sdk');
//you can get verification token and robot_jid in zoom marketplace features.
let zoomBot=client(your clientid,your Verification Token,your robot_jid);
```

#### create one business instance with oauth2 connection in zoombot

```js
//if use auth argument no need to import tokens argument
//access_token will auto be requested when judge expired
const userApp = zoomBot.create({
  auth: connection
});
```

#### use business instance to handle action(for now,only support getUser,channelList,sendMessage three action)

get user

```js
//if email is empty ,will return userId corresponds to the current access_token ,if send specific email，will return the corresponding sub-account under account 。
/* 
   interface UserInfo{
       id:string;//user id
       account_id:string;
       email:string;
       [propName: string]: any;
   }
   email?:string
*/

let userInfo = await userApp.getUser(email);
```

get channelList

```js

// the userId which you can get from getUser method or callback from on event message
/*
    interface ChannelItem{
       group_jid:string;
       name:string;
       type:number;
       created_time:number;
       modified_time:number;
    }

    channelInfo:Array<ChannelItem>
*/

let channelInfo=await userApp.channelList(userId);

```

sendMessage

```js
/* 
    body example:
    {
      "type": "message",
      "text": "this is sendmessage info",
      "style": { "color": "#000000", "bold": true, "itatic": false }
    }

    header example:
    { "text": "kogss" }

    Body:Array<Msg>|Msg;

    Interface Header{
        text:String;
        style:Style;
    }
    Interface Option{
        account_id:String;//account_id from getUser action userInfo
        to_jid:String;//to_jid from channelList group_jid
        body:Body;// send one or multiple message
        header:Header;
    }
*/

let backInfo = await userApp.sendMessage(option);
```



#### message event

handle request

```js
expressApp.get('/someapi', function(req, res, next) {
  let { body, headers } = req;
  zoomBot.handle({ body, headers }, function(err) {
    if (err) {
      console.log(err);
    }
  });
  res.send('some res');
});
```

listen message

```js
/* 
     interface Data{
            robotJid:String;
            userJid:String;
            toJid:String,
            accountId:String,
            userId:String,
            name:String,
            timestamp:Number,
            cmd:String
        }
*/

//support multiple async function
zoomBot.on('edit', function({ data }) {});

zoomBot.on('button', function({ data }) {});

zoomBot.on('dropdown', function({ data }) {});

zoomBot.on('notification', function({ data }) {});
```

#### body type

```js
//notification message
  {
            "type":"message",
            "text":"this is first message.",
            "style":{
               "color":"#FFFFFF",
               "bold":true,
               "itatic":false
            }
         }
//link message
 {
            "type":"message",
            "text":"zoom.us",
            "link":"https://zoom.us"
         }

//edit message

 {
            "type":"message",
            "text":"this message is mainly for editable feature",
            "editable":true
         }

//button
{
  "type":"actions",
            "limit":3,
            "items":[
               {
                  "text":"button1",
                  "value":"name1"
               },
               {
                  "text":"button2",
                  "value":"name2"
               },
               {
                  "text":"button3",
                  "value":"name3"
               }
            ]

}

items message

{
 "type":"fields",
            "items":[
               {
                  "key":"field1",
                  "value":"msg",
                  "isName":true,
                  "style":{
                     "color":"#123123",
                     "bold":true,
                     "itatic":false
                  }
               },
               {
                  "key":"field2",
                  "value":"zoom.us",
                  "link":"https://zoom.us"
               }
            ]


}

attachment message

{
           "type":"attachments",
            "text":"My Attachment",
            "resource_url":"https://zoom.us",
            "img_url":"#",
            "ext":"ext",
            "size":1000,
            "information":{
               "title":{
                  "text":"attachment title",
                  "style":{
                     "color":"#000000",
                     "bold":true,
                     "itatic":false
                  }
               },
               "description":{
                  "text":"attachment description",
                  "style":{
                     "color":"#987654",
                     "bold":false,
                     "itatic":true
                  }
               }
            }
}


select message

         {
            "type":"select",
            "text":"My Dropdown",
            "name":"",
            "style":{
               "color":"#987654",
               "bold":false,
               "itatic":true
            },
            "selected_item":{
               "text":"My Selected",
               "value":"My Selected"
            },
            "select_items":[//dropdown
               {

                  "text":"t1",
                  "value":"v1"
               },
               {
                  "text":"t2",
                  "value":"v2"
               },
               {
                  "text":"t3",
                  "value":"v3"
               },
               {
                  "text":"t4",
                  "value":"v4"
               },
               {
                  "text":"t5",
                  "value":"v5"
               }
            ]
         }


```

#### header type

```js

{"text":"your header text"}
or
{"text":"your header text",
        "style":{
        "color":"#000000",
        "bold":true,
        "itatic":false
        }
}
```
